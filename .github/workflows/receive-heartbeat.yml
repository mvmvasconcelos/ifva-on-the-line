name: Receive Heartbeat

on:
  repository_dispatch:
    types: [heartbeat]

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Important: allows the workflow to push changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update status file
        run: |
          # Get current UTC timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Update last_seen and status using jq (pre-installed on Ubuntu runners)
          jq --arg new_time "$TIMESTAMP" '.last_seen = $new_time | .status = "online"' data/status.json > temp.json && mv temp.json data/status.json
          
          # Show the updated file content for debugging
          cat data/status.json

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data/status.json
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "update: heartbeat recebido!"
            git push
          fi
