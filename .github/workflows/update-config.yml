name: Update Configuration

on:
  workflow_dispatch:
    inputs:
      alert_emails:
        description: 'Lista de emails separados por vírgula'
        required: true
        type: string
      email_subject:
        description: 'Assunto do email'
        required: true
        type: string
      email_body:
        description: 'Corpo do email'
        required: true
        type: string

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Read current status.json
        id: read_status
        run: |
          cat data/status.json > /tmp/current_status.json
      
      - name: Update configuration
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read current status
            const statusData = JSON.parse(fs.readFileSync('data/status.json', 'utf8'));
            
            // Parse email list
            const emailList = '${{ github.event.inputs.alert_emails }}'
              .split(',')
              .map(e => e.trim())
              .filter(e => e);
            
            // Update config
            statusData.config = {
              alert_emails: emailList,
              email_template: {
                subject: '${{ github.event.inputs.email_subject }}',
                body: '${{ github.event.inputs.email_body }}'
              }
            };
            
            // Write back
            fs.writeFileSync('data/status.json', JSON.stringify(statusData, null, 2));
            
            console.log('✅ Configuration updated successfully');
            console.log('New config:', JSON.stringify(statusData.config, null, 2));
      
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/status.json
          git diff --cached --quiet || git commit -m "Update email configuration via Settings"
          git push
      
      - name: Notify success
        run: |
          echo "✅ Configuration saved successfully!"
          echo "Alert emails: ${{ github.event.inputs.alert_emails }}"
